<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>로그인</title>
  <style>
    :root{
      --bg:#222;--muted:#94a3b8;--text:#e5e7eb;
      --brand:#0074e9;--brand-700:#005bb5;
      --danger:#ef4444;--shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial,sans-serif;
      min-height:100vh;display:flex;flex-direction:column
    }

    /* 헤더 */
    .header{background:var(--bg);color:var(--text);padding:20px;display:flex;align-items:center;gap:20px}
    .logo{
      font-family: Arial, sans-serif;
      font-size: 2em;
      font-weight: bold;
      color: var(--brand);
      cursor: pointer;
      user-select:none;
      line-height:1
    }
    .logo:focus{outline:2px solid #a8d1ff;border-radius:6px}
    .login-area{margin-left:auto}

    /* 카드 */
    .main{flex:1;display:grid;place-items:center;padding:24px}
    .card{
      width:min(520px,92vw);
      background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:28px
    }
    h1{margin:0 0 8px;font-size:28px}
    p.muted{color:var(--muted);margin:0 0 16px}
    form{display:grid;gap:12px}
    label{font-size:13px;color:var(--muted)}
    .field{position:relative}
    input{
      width:100%;padding:12px 14px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(2,6,23,.65);color:var(--text);outline:none
    }
    input:focus{border-color:rgba(59,130,246,.7);box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    .toggle{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:transparent;border:none;color:var(--muted);cursor:pointer}
    .btn{padding:12px 14px;border-radius:12px;border:none;background:var(--brand);color:white;font-weight:700;cursor:pointer}
    .btn:hover{background:var(--brand-700)}
    .bar{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
    a{color:#9ec2ff;text-decoration:none}
    .toast{position:fixed;bottom:20px;right:20px;background:rgba(17,24,39,.9);color:#fff;padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(8px);transition:.25s}
    .toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
  <div class="header">
    <div class="logo" id="logoHome" role="button" tabindex="0" aria-label="홈으로 이동">ENS</div>
    <div class="login-area" id="loginArea"></div>
  </div>

  <div class="main">
    <div class="card">
      <h1>로그인</h1>
      <form id="loginForm" autocomplete="on">
        <div>
          <label for="loginId">아이디 또는 이메일</label>
          <input id="loginId" required placeholder="아이디 또는 이메일" />
        </div>
        <div class="field">
          <label for="loginPw">비밀번호</label>
          <input id="loginPw" type="password" required placeholder="비밀번호" />
          <button id="togglePw" class="toggle" type="button">표시</button>
        </div>
        <button class="btn" type="submit">로그인</button>
        <div class="bar">
          <span class="muted">계정이 없나요?</span>
          <a href="signup.html">회원가입으로 이동</a>
        </div>
      </form>
    </div>
  </div>

  <div id="msg" class="toast" role="status" aria-live="polite"></div>

  <script>
    const USERS_KEY='demo_users', SESSION_KEY='demo_session';
    const $=s=>document.querySelector(s);
    const showToast=t=>{const m=$('#msg');m.textContent=t;m.classList.add('show');setTimeout(()=>m.classList.remove('show'),2000)};
    const loadUsers=()=>{try{return JSON.parse(localStorage.getItem(USERS_KEY))||[]}catch{return[]}};
    const saveSession=id=>localStorage.setItem(SESSION_KEY,JSON.stringify({id,at:Date.now()}));
    const getSession=()=>{try{return JSON.parse(localStorage.getItem(SESSION_KEY))}catch{return null}};

    // 헤더 login-area 렌더 (메인과 동일 동작)
    function renderLoginArea(){
      const area = document.getElementById('loginArea');
      const s = getSession();
      if(!area) return;

      if(!s){
        area.innerHTML = `
          <button id="goLogin" type="button"
            style="background:#0074e9;color:#fff;border:none;border-radius:6px;padding:10px 18px;font-weight:700;cursor:pointer">
            로그인
          </button>
          <a href="signup.html" style="margin-left:8px;color:#9ec2ff;text-decoration:none;font-weight:700">회원가입</a>
        `;
        document.getElementById('goLogin')?.addEventListener('click', () => {
          // 로그인 페이지에서 다시 로그인 누르면 현재 유지
          location.href = 'login.html';
        });
      } else {
        const users = loadUsers();
        const me = users.find(u => u.username === s.id || u.email === s.id);
        const display = me ? me.username : s.id;
        area.innerHTML = `
          <span style="margin-right:10px">👋 <b>${display}</b> 님</span>
          <button id="logoutBtn" type="button"
            style="background:#444;color:#fff;border:none;border-radius:6px;padding:10px 12px;font-weight:700;cursor:pointer">
            로그아웃
          </button>
        `;
        document.getElementById('logoutBtn')?.addEventListener('click', () => {
          localStorage.removeItem(SESSION_KEY);
          showToast('로그아웃 되었습니다');
          // 헤더 즉시 반영 + 홈으로 이동
          renderLoginArea();
          location.href = 'index.html#전체';
        });
      }
    }

    // 비밀번호 해시/검증
    const enc=new TextEncoder();
    const toHex=b=>Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join('');
    async function hashPw(pw,saltHex){
      const salt = Uint8Array.from(saltHex.match(/.{1,2}/g).map(h=>parseInt(h,16)));
      const combined=new Uint8Array(salt.length+enc.encode(pw).length);
      combined.set(salt,0); combined.set(enc.encode(pw),salt.length);
      const digest=await crypto.subtle.digest('SHA-256',combined);
      return toHex(digest);
    }
    const findUser=(us,id)=>{const k=id.trim().toLowerCase();return us.find(u=>u.username.toLowerCase()===k||u.email.toLowerCase()===k)};

    // 비밀번호 표시/숨김
    $('#togglePw').onclick=()=>{const f=$('#loginPw');f.type=f.type==='password'?'text':'password';$('#togglePw').textContent=f.type==='password'?'표시':'숨김'};

    // 로그인 제출
    $('#loginForm').onsubmit=async e=>{
      e.preventDefault();
      const id=$('#loginId').value, pw=$('#loginPw').value;
      const u=findUser(loadUsers(),id);
      if(!u){ showToast('계정을 찾을 수 없습니다'); return; }
      const digest=await hashPw(pw,u.saltHex);
      if(digest!==u.hashHex){ showToast('비밀번호가 올바르지 않습니다'); return; }
      saveSession(u.username);
      showToast('로그인 성공');
      // 헤더 갱신 후 홈으로
      renderLoginArea();
      location.href='index.html#전체';
    };

    // 로고 → 항상 홈(전체)
    const logoHome=document.getElementById('logoHome');
    logoHome.addEventListener('click',()=>{location.href='index.html#전체'});
    logoHome.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();location.href='index.html#전체';}});

    // 초기 렌더
    renderLoginArea();
</script>
</body>
</html>
